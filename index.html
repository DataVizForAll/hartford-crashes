<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Hartford Crashes</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.11.1/tachyons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
        
</head>

<body class="helvetica">

  <div id="map" class="vh-100 vw-100 bg-yellow"></div>

  <div id="legend" class="bg-white fixed top-0 left-0 pa3 mt2 ml2 br1" style="z-index: 999">
    <h1 class="f3 mt0">Hartford Crashes</h1>

    <p class="measure">
      This heatmap shows locations of car crashes in Hartford.
      Use the slider to change the time frame, and checkboxes
      to only show crashes with pedestrians or cyclists.
    </p>

    <form class="ph2">
      <input type="text" class="js-range-slider" name="dates" value="" />

      <div class="mt3 f6">
        <label>
          <input type="checkbox" id="pedestrians"> Crashes involving <b>pedestrians</b>
        </label>

        <br>

        <label>
          <input type="checkbox" id="cyclists"> Crashes involving <b>cyclists</b>
        </label>

        <br><br>

        <label>
          <input type="checkbox" id="labels" checked="checked"> Street labels
        </label>
        
        <br>

        <label>
          Intensity <input type="range" value="10" min="1" max="30" id="intensity" class="v-mid mr2">
        </label>

      </div>

    </form>


  </div>

  <script>

    var map = L.map('map', {
      zoomControl: false,
      center: [41.76, -72.67],
      zoom: 15
    })

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map)

    var labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19,
      pane: 'shadowPane'
    }).addTo(map)

    function dateToTS (date) {
      return date.valueOf()
    }
    
    function tsToDate (ts) {
      var d = new Date(ts)
  
      return d.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      })
    }

    var initFrom = dateToTS( new Date(2020, 0, 1) ) / 1000
    var initTo = dateToTS( new Date(2020, 6, 31) ) / 1000


    $.getJSON('data/crashes.json', function(data) {
      var heat = L.heatLayer( [], { radius: 20 } ).addTo(map)

      var updateHeatLayer = function(from, to) {

        var ped = $('#pedestrians').prop('checked')
        var cyc = $('#cyclists').prop('checked')
        var intensity = $('#intensity').val()

        // Add only points from timeframe and with filters
        heat.setLatLngs(
          data.filter(function(point) {
            return point.d >= from
              && point.d <= to
              && (cyc ? point.c === 1 : true)
              && (ped ? point.p === 1 : true)
          }).map(function(point) {
            return [point.x, point.y, intensity / 3.0]
          })
        )

      }

      var slider = $(".js-range-slider").ionRangeSlider({
        type: 'double',

        min: dateToTS(new Date(2015, 0, 1)),
        max: dateToTS(new Date(2020, 6, 31)),

        from: dateToTS(new Date(2020, 0, 1)),
        to: dateToTS(new Date(2020, 6, 31)),
        
        prettify: tsToDate,
        grid: true,
        grid_num: 4,

        onChange: function(sliderData) {

          var from = sliderData.from / 1000;
          var to = sliderData.to / 1000;

          updateHeatLayer(from, to)
        }
      });

      $('#intensity, #pedestrians, #cyclists').change(function(e) {
        updateHeatLayer(
          slider[0].value.split(';')[0] / 1000,
          slider[0].value.split(';')[1] / 1000
        )
      })

      $('#labels').change(function(e) {
        if ( $('#labels').prop('checked') ) {
          labels.addTo(map)
        } else {
          map.removeLayer(labels)
        }
      })

      // For the first time, load data
      $('#labels').prop('checked', 'checked')
      $('#cyclists, #pedestrians').prop('checked', false)
      $('#intensity').val(5)
      updateHeatLayer( initFrom, initTo )

    })

  </script>

  <style>
    .irs-bar, .irs-handle i, .irs-single, .irs-from, .irs-to {
      background-color: #333 !important;
    }

    .irs-single::before, .irs-from::before, .irs-to::before {
      border-top-color: #333 !important;
    }
  </style>

</body>
</html>